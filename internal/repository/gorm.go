package repository

import (
	"fmt"
	"time"

	"github.com/csye7125-su24-team06/webapp-cve-processor/internal/models"
	"github.com/csye7125-su24-team06/webapp-cve-processor/pkg/database"

	"gorm.io/gorm/clause"
)

type gormRepository struct{
	dataSource database.GormDataSource
}

func NewGormRepository(dataSource database.GormDataSource) CveRepository {
	return &gormRepository{
		dataSource: dataSource,
	}
}

func (gr *gormRepository) InsertCve(cveDoc interface{}) {
	gr.dataSource.Get().Create(&cveDoc)
}

func (gr *gormRepository) BulkInsertCve(cveDocs []models.Cve) {
	timeInit := time.Now()
	result := gr.dataSource.Get().Clauses(clause.OnConflict{DoNothing: true}).Create(cveDocs)
	if result.Error != nil {
		panic(result.Error)
	}
	fmt.Println("Time taken to insert records: ", time.Since(timeInit).Seconds())
}

func (gr *gormRepository) FindCves(cveId string) (interface{}) {
	var cveDoc models.Cve
	gr.dataSource.Get().Where("cve_id = ?", cveId).Order("date_updated DESC").Limit(1).First(&cveDoc)
	return cveDoc
}
