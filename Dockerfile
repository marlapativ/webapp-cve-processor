FROM golang:1.22.2-alpine as builder
WORKDIR /webapp

COPY go.mod .
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 go build -o /bin/webapp cmd/main.go

# Run the tests in the container
FROM builder AS test
RUN go test -v ./...

FROM scratch
COPY --from=builder /bin/webapp /bin/webapp
ENTRYPOINT ["/bin/webapp"]
